YUI.add("moodle-atto_subtitle-button",function(e,t){var n="atto_subtitle",r="subtitle",i={LINK:"link",MEDIA:"media"},s={LINK:"link",VIDEO:"video",AUDIO:"audio"},o={VIDEO:"atto_subtitle_video",AUDIO:"atto_subtitle_audio",UPLOAD:"atto_subtitle_upload",SUBTITLE:"atto_subtitle_subtitle",SUBTITLE_CHECKBOX:"atto_subtitle_subtitle_checkbox",MEDIAINSERT_CHECKBOX:"atto_subtitle_mediainsert_checkbox",ATTO_CLOUDPOODLL_FORM:"atto_subtitle_form",CP_VIDEO:"atto_subtitle_video_cont",CP_AUDIO:"atto_subtitle_audio_cont",CP_UPLOAD:"atto_subtitle_upload_cont",CP_SWAP:"atto_subtitle_swapmeout"},u={subtitling:!1,selectednode:!1,selectednodetype:!1,mediaurl:!1,fullurl:!1},a={ROOT:'<div class="subtitlewrapper">\n\n            <div class="subtitlepreviewplayer" id="root">\n\n                \n\n                <div id="poodllsubtitle_previewbox" class="poodllsubtitle_previewbox top-box">\n                    <video id="poodllsubtitle_video" class="poodllsubtitle_video" width="100%" style="display: none"></video>\n                    <audio id="poodllsubtitle_audio" class="poodllsubtitle_audio" width="100%" style="display: none"></audio>\n                    <div id="poodllsubtitle_previewline"  class="poodllsubtitle_previewline text-box"></div>\n                </div>\n\n                <div class="bottom-box">\n                    <div class="control-panel">\n                        <div class="preview-progress-bar">\n                            <span class="time time-current">0:00</span>\n                            <div class="progress-line">\n                                <span class="green-progress"></span>\n                                <span class="progress-marker"></span>\n                            </div>\n                            <span class="time time-total">0:00</span>\n                        </div>\n                        <div class="buttons-group">\n                            <a id="poodllsubtitle_addnew" class="poodllsubtitle_addnew btn add" title="{{get_string "addnew" component}}"></a>\n                            <a class="btn prev" id="btn_prev" title="{{get_string "stepback" component}}"></a>\n                            <a class="btn play" id="btn_play" title="{{get_string "playpause" component}}"></a>\n                            <a class="btn next" id="btn_next" title="{{get_string "stepahead" component}}"></a>\n                        </div>\n                    </div>\n                    <div class="subtitleset_container">\n                        <div id=\'poodllsubtitle_tiles\' class=\'poodllsubtitle_tiles subtitleset_list\'></div>\n                        <div class="save_and_download">\n                            <a class="save_btn" href="#" id="poodllsubtitle_save">{{get_string "savesubtitles" component}}</a>\n                            <a class="cancel_btn" href="#" id="poodllsubtitle_removeall" title="{{get_string "removesubtitles" component}}"></a>\n                        </div>\n                    </div>\n                </div>\n\n                <div id=\'poodllsubtitle_editor\' class="\'poodllsubtitle_editor\' subtitleset_block subtitleset_block_open" style=\'display: none;\'>\n                        <div class="numb_song"></div>\n                        <div class="subtitleset_time">\n                            <div class="block_input">\n                                <input type="text" name="poodllsubtitle_edstart" id="poodllsubtitle_edstart" class="poodllsubtitle_edstart">\n                                <div class="input_arr_block">\n                                    <div id="poodllsubtitle_startbumpup" class="input_arr input_arr_top"></div>\n                                    <div id="poodllsubtitle_startbumpdown" class="input_arr input_arr_bot"></div>\n                                </div>\n                            </div>\n                            <button type="button" id="poodllsubtitle_startsetnow" class="poodllsubtitle_startsetnow now_btn">{{get_string "now" component}}</button>\n                            <div class="block_input">\n                                <input type="text" name="poodllsubtitle_edend" id="poodllsubtitle_edend" class="poodllsubtitle_edpart">\n                                <div class="input_arr_block">\n                                    <div id="poodllsubtitle_endbumpup" class="input_arr input_arr_top"></div>\n                                    <div id="poodllsubtitle_endbumpdown" class="input_arr input_arr_bot"></div>\n                                </div>\n                            </div>\n                            <button type="button" id="poodllsubtitle_endsetnow" class="poodllsubtitle_endsetnow now_btn">{{get_string "now" component}}</button>\n                        </div>\n                        <div class="subtitleset_text">\n                            <textarea class="textarea" name="poodllsubtitle_edpart" id="poodllsubtitle_edpart" class="poodllsubtitle_edpart"></textarea>\n                        </div>\n                        <div class="subtitleset_btns">\n                            <div class="subs_btn_block subs_basket poodllsubtitle_eddelete" id="poodllsubtitle_eddelete">\n                                <img src="{{imgpath}}btn_ic_1.svg">\n                            </div>\n                            <div class="subs_btn_block subs_btn_menu poodllsubtitle_edapply" id="poodllsubtitle_edapply"></div>\n                            <div class="subs_btn_block poodllsubtitle_edmergeup" id="poodllsubtitle_edmergeup">\n                                <img src="{{imgpath}}btn_ic_2.svg">\n                            </div>\n                            <div class="subs_btn_block poodllsubtitle_edsplit" id="poodllsubtitle_edsplit">\n                                <img src="{{imgpath}}btn_ic_3.svg">\n                            </div>\n                            <button type="button" id="poodllsubtitle_edcancel" class="poodllsubtitle_edcancel">{{get_string "cancel" component}}</button>\n                        </div>\n                    </div>\n\n            </div>\n        </div>'
,HTML_MEDIA:{VIDEO:'&nbsp;<video &nbsp;<audio controls="true" crossorigin="anonymous"><source src="{{url}}">{{#if issubtitling}}<track src="{{subtitleurl}}" kind="captions" srclang="{{language}}" label="{{language}}" default="true">{{/if}}</video>&nbsp;',AUDIO:'&nbsp;<audio controls="true" crossorigin="anonymous"><source src="{{url}}">{{#if issubtitling}}<track src="{{subtitleurl}}" kind="captions" srclang="{{language}}" label="{{language}}" default="true">{{/if}}</audio>&nbsp;',LINK:'&nbsp;<a href="{{url}}" {{#if issubtitling}} data-subtitles="{{subtitleurl}}" data-language="{{language}}" {{/if}}>{{name}}</a>&nbsp;'},CAPTIONTRACK:'<track src="{{subtitleurl}}" kind="captions" srclang="{{language}}" label="{{language}}" default="true">'};e.namespace("M.atto_subtitle").Button=e.Base.create("button",e.M.editor_atto.EditorPlugin,[],{initializer:function(e){e.disabled||this.addButton({icon:r,iconComponent:n,title:"subtitle",buttonName:r,callback:this._displayDialogue,callbackArgs:null,tags:"a,video,audio",tagMatchRequiresAll:!1})},_getContext:function(t){return e.merge({elementid:this.get("host").get("elementid"),imgpath:M.cfg.wwwroot+"/lib/editor/atto/plugins/subtitle/pix/e/",component:n,helpStrings:this.get("help"),CSS:o},t)},_displayDialogue:function(t,i){if(this.get("host").getSelection()===!1)return;var s=this.get("host").getSelectedNodes().filter("video,audio,a");if(!s||s.size()==0){var o=this.get("host").getSelectionParentNode();if(!o)return;anchornodes=this._findSelectedAnchors(e.one(o));if(anchornodes.length==0)return}var a=M.util.get_string("subtitle",n),f="1200px",l={};l.headerContent=a,l.focusAfterHide=r,l.width=f;var c=this.getDialogue(l);c.set("bodyContent",this._getDialogueContent()).show(),u.elementid=this.get("host").get("elementid");var h=this;this._loadSubtitleEditor()},_loadSubtitleEditor:function(){var e=this,t=this.get("host");e.uploaded=!1;var r=t.getSelectedNodes().filter("video,audio").shift();if(r){var o=this._fetchSelectedURLs_mediatag(r);u.selectednode=r,u.selectednodetype=i.MEDIA}else{u.selectednodetype=i.LINK;var o=this._fetchSelectedURLs_anchor()}u.mediaurl=o.mediaurl,u.fullurl=o.fullurl;var a=function(t,r){switch(t){case"upload-ended":var i=!1,s=window.JSON.parse(r);s&&("url"in s?i=s.url:"newfile"in s&&(i=s.newfile.url)),i?e._updateAndClose(i):(alert(M.util.get_string("uploadproblem",n)),loader.do_download());break;case"remove-subtitles":e._removeAndClose(!1);break;default:}},f=r?this._getMediumProperties(r):!1,l=s.VIDEO;f&&(l=f.type),require(["atto_subtitle/loader"],function(e){e.init(t,a,o,l)})},_fetchSelectedURLs_mediatag:function(e){var t={mediaurl:!1,vtturl:!1,fullurl:!1},n=e?this._getMediumProperties(e):!1;return n&&(n.sources&&n.sources.length>0?t.mediaurl=n.sources[0]:t.mediaurl=n.src,t.fullurl=t.mediaurl,n.tracks&&"captions"in n.tracks&&n.tracks.captions.length>0&&(t.vtturl=n.tracks.captions[0].src)),t},_getMediumProperties:function(e){var t=function(e,t){return e.getAttribute(t)?!0:!1},n={subtitles:[],captions:[],descriptions:[],chapters:[],metadata:[]};return e.all("track").each(function(e){n[e.getAttribute("kind")].push({src:e.getAttribute("src"),srclang:e.getAttribute("srclang"),label:e.getAttribute("label"),defaultTrack:t(e,"default")})}),{type:e.test("video")?s.VIDEO:s.AUDIO,sources:e.all("source").get("src"),src:e.getAttribute("src"),poster:e.getAttribute("poster"),width:e.getAttribute("width"),height:e.getAttribute("height"),autoplay:t(e,"autoplay"),loop:t(e,"loop"),muted:t(e,"muted"),controls:t(e,"controls"),tracks:n}},_fetchSelectedURLs_anchor:function(){var t=this.get("host").getSelectionParentNode(),n=null,r=null,i={mediaurl:!1,vtturl:!1,fullurl:!1};if(!t)return i;n=this._findSelectedAnchors(e.one(t));if(n.length>0){r=n[0],u.selectednode=r,i.fullurl=r.getAttribute("href"),i.mediaurl=i.fullurl;if(i.fullurl!=""){var s=new URL(i.fullurl),o=new URLSearchParams(s.search);o&&(i.vtturl=o.get("data-subtitles"),i.mediaurl=i.fullurl.replace(s.search,""))}}return i},_findSelectedAnchors:function(e){var t=e.get("tagName"),n,r;return t&&t.toLowerCase()==="a"?[e]:(r=[],e.all("a").each(function(e){!n&&this.get("host").selectionContainsNode(e)&&r.push(e)},this),r.length>0?r:(n=e.ancestor("a"),n?[n]:[]))},_getDialogueContent:function(t){var n=e.Node.create(e.Handlebars.compile(a.ROOT)(this._getContext()));return n},_removeAndClose:function(e){var t=!1;if(u.selectednodetype===i.MEDIA)u.selectednode.all("track").each(function(e){e.getAttribute("kind")=="captions"&&!t&&(e.setAttribute("src",""),t=!0)});else{var n=new URL(u.fullurl),r="",s=new URLSearchParams(n.search);s?(s.delete("data-subtitles"),r=s.toString()):r="",r=decodeURIComponent(r),n.search=r,u.selectednode.setAttribute("href",n.href),t=!0}this.getDialogue({focusAfterHide:null}).hide(),this.markUpdated()},_updateAndClose:function(t){var n=!1;if(u.selectednodetype==i.MEDIA){u.selectednode.all("track").each(function(e){e.getAttribute("kind")=="captions"&&!n&&(e.setAttribute("src",t),n=!0)});if(!n){var r={};r.subtitleurl=t,r.language="captions";var s=e.Node.create(e.Handlebars.compile(a.CAPTIONTRACK)(r));u.selectednode.append(s)}}else{var o=new URL(u.fullurl),f="",l=new URLSearchParams(o.search);l?(l.set("data-subtitles",t),f=l.toString()):f="?data-subtitles="+t,f=decodeURIComponent(f),o.search=f,u.selectednode.setAttribute("href",o.href),n=!0}this.getDialogue({focusAfterHide:null}).hide(),this.markUpdated()}},{ATTRS:{disabled:{value:!1}}})},"@VERSION@");
